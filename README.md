# <p align="center">Client CBR  

---  

### Исходные данные
Реализовать скрипт загрузки официальных курсов ЦБ РФ в БД, используя веб-сервис [ЦБ РФ](https://cbr.ru/DailyInfoWebServ/DailyInfo.asmx), реализуемый метод - GetCursOnDateXML.
Стек - Python 3.10, БД - sqlite.
Обязательные входные аргументы командной строки для скрипта - дата курса(формат даты - '%d.%m.%Y') и список цифровых кодов валют через запятую.
Предусмотреть:
1) логирование выполнения скрипта с одновременным выводом в файл(название файла соответсвует названию скрипта + '.log') и в стандартный поток вывода(консоль); формат логирования на свое усмотрение.
2) Создание БД и таблиц из запускаемого скрипта;
3) возможность повторного запуска скрипта с загрузкой курсов в ранее созданую БД с сохранением предудыщих загруженных данных и файла логирования;
4) проверки на наличие уже загруженных распоряжений и курсов с игнорированием их к загрузке и с выводом данного факта в лог;
5) после загрузки курсов в БД вывести через функцию print все курсы из БД за дату, которая была указана во входных аргументах скрипта, со следующей информацией курса: Номер распоряжения, Дата установки курсов, Валюта, Номинал, Курс.
Выполненное задание разместить на github\gitlab и т.п.  
Все остальное, о чем тут не упомянуто, реализовывается на свой "вкус".  
Описание сущностей БД:
1) CURRENCY_ORDER - "Распоряжения о загрузке курсов":
> - id - INT - Номер распоряжения(Первичный ключ);
> - ondate - TEXT - Дата установки курсов ЦБ РФ(Уникальное, обязательное значение);
2) CURRENCY_RATES - "Курсы валют":
> - order_id - INT - Номер распоряжения(Внешний ключ на CURRENCY_ORDER.id );
> - name - TEXT - Наименование валюты(обязательное значение);
> - numeric_code - TEXT - Цифровой код валюты(обязательное значение);
> - alphabetic_code - TEXT - Буквенный код валюты(обязательное значение);
> - scale - INT - Номинал курса(обязательное значение);
> - rate - TEXT - Значение курса(обязательное значение);

Будет плюсом:
> - минимальное использование сторонних библиотек;
> - наличие тестов;

---

### Описание алгоритма

Основной алгоритм приложения подразумевает конвейерную обработку данных, поэтому наиболее подходящим с т.з. архитектуры для главного модуля проекта - client.py - является поведенческий паттерн проектирования Chain of responsibilities (цепочка обязанностей). Программно конвейер построен из последовательно вызываемых сопрограмм, каждая из которых может быть прервана возникающими в процессе выполнения сопрограммы отказами (ошибки валидации, отказ сервера, отказ БД и пр.). Инициализация сопрограмм обеспечивается декорирующей функцией def coroutine(func).  

Задача разбита на этапы:  
1) валидация входных данных;  
2) загрузка информации с сервера;  
3) парсинг ответа;  
4) загрузка данных в БД с выполнением заданного алгоритма проверки;  
5) печать в консоль списка курсов за заданную дату;
6) модульное тестирование

Остальные модули реализуют простые интерфейсы для выполнения конкретных этапов.  
Модуль db.py реализует интерфейс DB_manager для работы с СУБД sqlite3 на основе порождающего паттерна Builder. Интерфейс обеспечивает работу с БД по протоколу контекстного мененджера.  

---

### Использованные сторонние библиотеки

1) requests
2) pytest

---

### Установка
1) В локальную папку клонируем файлы проекта:
```shell
git clone git@github.com:AlekseyGolikov/Client_CBR.git
```
2) Устанавливаем в папку .../Client_CBR виртуальное окружение. Далее устанавливаем все зависимости, используемые скриптом:
```shell
pip install -r requirements.txt
```
4) Переходим в каталог tests и запускаем тестирование в режиме показа полной информации о пройденном тесте  
```shell
cd tests/
pytest -v
```
*Прим.: PASSED - тестовая функция завершилась успешно; XFAIL - тестовая функция завершилась с ожидаемым сбоем*  

5) Запускаем скрипт в работу:
```shell
python client.py 10.08.2022 826,840,978,156
```
---

### Использование скрипта в тестовом режиме
1) Для проверки скрипта в тестовом режиме реализована загрузка исходных данных из тестового файла `tests/response_08_08_2022.txt` . Для этого необходимо в файле `download.py` закомментировать часть кода, которая отвечает за получение данных от web-сервера, и убрать комментарии с кода, отвечающего за загрузку данных из файла:  
```python
# download.py  
    
    ...
#     response = requests.post(url, data=body, headers=headers)
#     if response.status_code != 200:
#         logs.logger.warning('Отказ. Код ответа сервера: {}'.format(response.status_code))
#         return False
#     logs.logger.info('Успешно получен ответ от сервера')
#     return response.text

    RESPONSE_FILE_NAME = 'tests/response__08_08_2022.txt'
    try:
        with open(RESPONSE_FILE_NAME, 'r', encoding='utf-8') as f:
            response = f.read()
    except:
        logs.logger.warning('Файл {} не найден'.format(RESPONSE_FILE_NAME))
        response = False
    return response
    ...
    
```
2) Запустить скрипт следующей командой:  
```shell
python client.py 08.08.2022 826,840,978,156
```
---

### Ограничения
1) Некорректно введённые входные данные отбрасываются. В лог и в консоль выводится соответствующая предупреждающая информация    
2) Допускается ввод несуществующих цифровых кодов, в этом случае в лог и консоль выводится соответствующее сообщение. Сообщение выводится только в том случае, если ВСЕ коды из списка не существуют, иначе несуществующие коды отбрасываются без оповещения, а по оставшимся записывается информация в БД.  

---
  
